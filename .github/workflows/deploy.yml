name: Deploy Admin Frontend to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1Ô∏è‚É£ Configure AWS credentials (optional if you use S3 or AWS CLI)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 2Ô∏è‚É£ Setup SSH
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

      # 3Ô∏è‚É£ Add EC2 host to known_hosts
      - name: Add EC2 host to known_hosts
        run: |
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # 4Ô∏è‚É£ Test SSH connection
      - name: Test SSH Connection
        run: ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo SSH connection successful"

      # 5Ô∏è‚É£ Deploy to EC2
      - name: Pull latest code, build and restart frontend service
        run: |
          ssh -o StrictHostKeyChecking=no -t ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << ENDSSH
            set -e

            echo "üöÄ Starting frontend deployment..."
            cd ${{ secrets.DEPLOY_PATH }}/rahulladumor-frontend

            # Pull latest code
            echo "Fetching latest code from main branch..."
            git fetch origin
            git reset --hard origin/main

            echo "Installing dependencies..."
            # Create .env file BEFORE build
            echo "Creating .env file..."
            echo "NEXT_PUBLIC_BACKEND_API_URL=${{ secrets.FRONTEND_BACKEND_API_URL }}" > .env
            echo "NEXT_PUBLIC_CALENDLY_URL=${{ secrets.FRONTEND_CALENDLY_URL }}" >> .env
            echo "NEXT_PUBLIC_GA4_MEASUREMENT_ID=${{ secrets.NEXT_PUBLIC_GA4_MEASUREMENT_ID }}" >> .env
            echo "‚úÖ Environment file created"

            # Install dependencies
            npm install

            # Build Next.js application
            echo "Building Next.js application..."
            npm run build

            # Restart PM2 process for frontend
            echo "Restarting PM2 process..."
            pm2 reload frontend --update-env || pm2 start npm --name frontend -- start
            pm2 save

            echo "‚úÖ Frontend deployment completed successfully!"
          ENDSSH
